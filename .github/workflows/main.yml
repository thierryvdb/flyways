name: Main

on:
  push:
    branches:
      - main

jobs:
  lint:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Sql Lint Check
        uses: Bidaya0/sql-lint-in-action@v0.0.2
        with:
          #path: ${{ github.workspace }}/Coffee/migrations/*.sql
          path:  '**/*.{sql}'
          host: 192.168.60.65
          user: ${{ secrets.USER }}
          password: ${{ secrets.DB_PASSWORD }}
          driver: mysql
          port: 3306
          ignore_errors:

  sqlfluff:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Check with SqlFluff
        uses: yu-iskw/action-sqlfluff@v3
        with:
          github_token: ${{ secrets.github_token }}
          reporter: github-pr-review
          sqlfluff_version: "2.0.7"
          sqlfluff_command: "lint" # "fix " Or "lint"
          config: "${{ github.workspace }}/.sqlfluff"
          paths: '${{ github.workspace }}/models'
          github_base_ref: "main"
      - name: Show outputs (Optional)
        run: |
          echo '${{ steps.lint-sql.outputs.sqlfluff-results }}' | jq -r '.'
          echo '${{ steps.lint-sql.outputs.sqlfluff-results-rdjson }}' | jq -r '.'

  migrate:
    runs-on: self-hosted
    needs:
      - lint
      - sqlfluff

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Migrate Step
        uses: joshuaavalon/flyway-action@v3.0.0
        with:
          url: jdbc:mysql://192.168.60.65:3306/${{ secrets.DB }}
          user: ${{ secrets.USER }}
          password: ${{ secrets.DB_PASSWORD }}
        env:
          FLYWAY_VALIDATE_MIGRATION_NAMING: true

      - name: Migrate
        run: /home/thierry/Downloads/flyway/flyway migrate -configFiles="/home/thierry/Documents/flyways/Coffee/flyway.toml,/home/thierry/Documents/flyways/Coffee/flyway.user.toml" -workingDirectory="/home/thierry/Documents/flyways/Coffee" -reportEnabled=false -environment=development -url="jdbc:mysql://192.168.60.65:3306" -user=${{ secrets.USER }} -password=${{ secrets.DB_PASSWORD }} -schemas=${{ secrets.DB }}

        
